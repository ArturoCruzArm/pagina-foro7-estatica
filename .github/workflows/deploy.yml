name: Build, Optimize & Deploy to GitHub Pages

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install build dependencies
        run: |
          npm install -g terser clean-css-cli html-minifier-terser
          sudo apt-get update && sudo apt-get install -y webp

      - name: Convert images to WebP
        run: |
          echo "Converting images to WebP format..."
          find images -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" 2>/dev/null | while read img; do
            if [ -f "$img" ]; then
              webp_file="${img%.*}.webp"
              if [ ! -f "$webp_file" ]; then
                cwebp -q 80 "$img" -o "$webp_file" 2>/dev/null && echo "✅ Converted: $img"
              fi
            fi
          done
          # Convert og-image
          if [ -f "og-image.jpg" ] && [ ! -f "og-image.webp" ]; then
            cwebp -q 85 og-image.jpg -o og-image.webp && echo "✅ Converted: og-image.jpg"
          fi
          echo "WebP conversion complete!"

      - name: Minify CSS
        run: |
          cleancss -o styles.min.css styles.css
          mv styles.min.css styles.css
          echo "✅ CSS minified: $(wc -c < styles.css) bytes"

      - name: Minify JavaScript
        run: |
          terser script.js -o script.min.js -c -m
          mv script.min.js script.js
          echo "✅ JS minified: $(wc -c < script.js) bytes"
          terser service-worker.js -o service-worker.min.js -c -m
          mv service-worker.min.js service-worker.js
          echo "✅ SW minified: $(wc -c < service-worker.js) bytes"

      - name: Minify HTML
        run: |
          # Minify main index.html
          html-minifier-terser \
            --collapse-whitespace \
            --remove-comments \
            --remove-redundant-attributes \
            --remove-script-type-attributes \
            --remove-style-link-type-attributes \
            --use-short-doctype \
            --minify-css true \
            --minify-js true \
            -o index.min.html \
            index.html
          mv index.min.html index.html
          echo "✅ index.html minified: $(wc -c < index.html) bytes"

          # Minify offline.html
          if [ -f "offline.html" ]; then
            html-minifier-terser --collapse-whitespace --remove-comments --minify-css true --minify-js true -o offline.min.html offline.html
            mv offline.min.html offline.html
            echo "✅ offline.html minified"
          fi

          # Minify English version
          if [ -f "en/index.html" ]; then
            html-minifier-terser --collapse-whitespace --remove-comments --minify-css true --minify-js true -o en/index.min.html en/index.html
            mv en/index.min.html en/index.html
            echo "✅ en/index.html minified"
          fi

      - name: Show optimized file sizes
        run: |
          echo "=== Final Optimized File Sizes ==="
          ls -lh index.html styles.css script.js service-worker.js
          echo ""
          echo "=== Total size ==="
          du -ch index.html styles.css script.js service-worker.js | grep total

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
